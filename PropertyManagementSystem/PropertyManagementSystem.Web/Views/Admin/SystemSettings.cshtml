@model List<PropertyManagementSystem.BLL.DTOs.Admin.SystemSettingDto>
@{
    ViewData["Title"] = "System Settings";
    Layout = "_AuthLayout";
    var selectedCategory = ViewBag.SelectedCategory as string;
    var categories = Model.Select(s => s.Category).Distinct().OrderBy(c => c).ToList();
}

<style>
    .settings-container { padding: 10px 0; }
    .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .settings-header h1 { font-size: 28px; font-weight: 700; color: #1e293b; margin: 0; }
    .btn-add { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btn-add:hover { background: #1d4ed8; }
    .filter-bar { background: white; border-radius: 16px; padding: 16px 24px; border: 1px solid #e2e8f0; margin-bottom: 24px; display: flex; gap: 12px; align-items: center; }
    .filter-bar label { font-size: 14px; font-weight: 500; color: #64748b; }
    .filter-bar select { padding: 8px 14px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; min-width: 180px; }
    .filter-bar select:focus { outline: none; border-color: #2563eb; }
    .settings-grid { display: grid; gap: 16px; }
    .setting-card { background: white; border-radius: 16px; padding: 20px 24px; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
    .setting-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .setting-info { flex: 1; }
    .setting-key { font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .setting-key .badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
    .badge-category { background: #e0e7ff; color: #4338ca; }
    .badge-type { background: #f1f5f9; color: #64748b; }
    .badge-public { background: #d1fae5; color: #047857; }
    .setting-desc { font-size: 13px; color: #64748b; margin-bottom: 6px; }
    .setting-value { font-size: 14px; color: #1e293b; background: #f8fafc; padding: 8px 12px; border-radius: 8px; font-family: monospace; word-break: break-all; max-width: 400px; }
    .setting-meta { font-size: 12px; color: #94a3b8; margin-top: 8px; }
    .setting-actions { display: flex; gap: 8px; margin-left: 20px; }
    .btn-edit { padding: 8px 16px; border-radius: 8px; font-size: 13px; border: none; cursor: pointer; background: #e0f2fe; color: #0369a1; }
    .btn-edit:hover { background: #bae6fd; }
    .btn-delete { padding: 8px 16px; border-radius: 8px; font-size: 13px; border: none; cursor: pointer; background: #fee2e2; color: #dc2626; }
    .btn-delete:hover { background: #fecaca; }
    .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 16px; border: 1px solid #e2e8f0; }
    .empty-state i { font-size: 48px; color: #cbd5e1; }
    .empty-state p { color: #94a3b8; margin-top: 12px; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; border-radius: 20px; width: 90%; max-width: 500px; padding: 32px; position: relative; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-header h2 { font-size: 22px; font-weight: 700; color: #1e293b; margin: 0; }
    .modal-close { background: none; border: none; font-size: 24px; color: #94a3b8; cursor: pointer; }
    .modal-close:hover { color: #64748b; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-check { display: flex; align-items: center; gap: 8px; }
    .form-check input[type="checkbox"] { width: 18px; height: 18px; }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
    .btn-cancel { padding: 10px 20px; border-radius: 8px; font-weight: 500; background: #f1f5f9; color: #475569; border: none; cursor: pointer; }
    .btn-cancel:hover { background: #e2e8f0; }
    .btn-submit { padding: 10px 20px; border-radius: 8px; font-weight: 500; background: #2563eb; color: white; border: none; cursor: pointer; }
    .btn-submit:hover { background: #1d4ed8; }
</style>

<div class="settings-container">
    <div class="settings-header">
        <h1>System Settings</h1>
        <button class="btn-add" onclick="openCreateModal()">
            <i class="bi bi-plus-lg"></i> Add Setting
        </button>
    </div>

    <div class="filter-bar">
        <label>Filter by Category:</label>
        <select id="categoryFilter" onchange="filterByCategory()">
            <option value="">All Categories</option>
            @foreach (var cat in categories)
            {
                <option value="@cat" selected="@(selectedCategory == cat)">@cat</option>
            }
        </select>
        <a href="@Url.Action("SystemSettings", "Admin")" class="btn-cancel" style="margin-left: auto;">Reset</a>
    </div>

    <div class="settings-grid">
        @if (Model.Any())
        {
            foreach (var setting in Model)
            {
                <div class="setting-card">
                    <div class="setting-info">
                        <div class="setting-key">
                            @setting.SettingKey
                            <span class="badge badge-category">@setting.Category</span>
                            <span class="badge badge-type">@setting.DataType</span>
                            @if (setting.IsPublic)
                            {
                                <span class="badge badge-public">Public</span>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(setting.Description))
                        {
                            <div class="setting-desc">@setting.Description</div>
                        }
                        <div class="setting-value">@setting.SettingValue</div>
                        <div class="setting-meta">
                            Updated: @setting.UpdatedAt.ToString("MMM dd, yyyy HH:mm")
                            @if (!string.IsNullOrEmpty(setting.UpdatedByName))
                            {
                                <text>by @setting.UpdatedByName</text>
                            }
                        </div>
                    </div>
                    <div class="setting-actions">
                        <button class="btn-edit" onclick="openEditModal(@setting.SettingId, '@setting.SettingKey', '@setting.SettingValue.Replace("'", "\\'").Replace("\n", "\\n")', '@setting.Description?.Replace("'", "\\'")?.Replace("\n", "\\n")')">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <form method="post" asp-action="DeleteSetting" style="display:inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="settingId" value="@setting.SettingId" />
                            <button type="submit" class="btn-delete" onclick="return confirm('Are you sure you want to delete this setting?')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <i class="bi bi-gear"></i>
                <p>No settings found. Click "Add Setting" to create one.</p>
            </div>
        }
    </div>
</div>

<!-- Create Setting Modal -->
<div class="modal-overlay" id="createModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Setting</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <form method="post" asp-action="CreateSetting">
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label>Setting Key <span style="color:#dc2626;">*</span></label>
                <input type="text" name="SettingKey" required placeholder="e.g. smtp_host" />
            </div>
            <div class="form-group">
                <label>Setting Value <span style="color:#dc2626;">*</span></label>
                <textarea name="SettingValue" required placeholder="Enter value..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <select name="Category">
                        <option value="General">General</option>
                        <option value="Email">Email</option>
                        <option value="Payment">Payment</option>
                        <option value="Security">Security</option>
                        <option value="AI">AI</option>
                        <option value="Notification">Notification</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Type</label>
                    <select name="DataType">
                        <option value="String">String</option>
                        <option value="Int">Int</option>
                        <option value="Bool">Bool</option>
                        <option value="JSON">JSON</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" name="Description" placeholder="Brief description..." />
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" name="IsPublic" value="true" />
                    <label>Public (visible to all users)</label>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn-submit">Create Setting</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Setting Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Setting</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form method="post" asp-action="UpdateSetting">
            @Html.AntiForgeryToken()
            <input type="hidden" name="SettingId" id="editSettingId" />
            <div class="form-group">
                <label>Setting Key</label>
                <input type="text" id="editSettingKey" disabled style="background:#f1f5f9;" />
            </div>
            <div class="form-group">
                <label>Setting Value <span style="color:#dc2626;">*</span></label>
                <textarea name="SettingValue" id="editSettingValue" required></textarea>
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" name="Description" id="editDescription" placeholder="Brief description..." />
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn-submit">Save Changes</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function filterByCategory() {
            const category = document.getElementById('categoryFilter').value;
            const url = category ? '@Url.Action("SystemSettings", "Admin")?category=' + encodeURIComponent(category) : '@Url.Action("SystemSettings", "Admin")';
            window.location.href = url;
        }

        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function openEditModal(id, key, value, desc) {
            document.getElementById('editSettingId').value = id;
            document.getElementById('editSettingKey').value = key;
            document.getElementById('editSettingValue').value = value;
            document.getElementById('editDescription').value = desc || '';
            document.getElementById('editModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.getElementById('createModal').addEventListener('click', function(e) {
            if (e.target === this) closeCreateModal();
        });

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreateModal();
                closeEditModal();
            }
        });
    </script>
}

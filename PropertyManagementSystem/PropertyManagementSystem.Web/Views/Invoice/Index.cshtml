@model List<PropertyManagementSystem.BLL.DTOs.Invoice.InvoiceDto>
@{
    ViewData["Title"] = "My Invoices";
    Layout = "_AuthLayout";
    ViewData["PortalMode"] = "Landlord";
}

<div class="pm-page">
    <div class="pm-page-header">
        <div>
            <h1 class="pm-page-title">
                <i class="bi bi-receipt"></i>
                My Invoices
            </h1>
            <p class="pm-page-subtitle">View and download all your invoices</p>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <!-- Stats -->
        <div class="pm-stats-row">
            <div class="pm-stat-card">
                <div class="pm-stat-icon primary">
                    <i class="bi bi-receipt"></i>
                </div>
                <div class="pm-stat-content">
                    <span class="pm-stat-label">Total Invoices</span>
                    <span class="pm-stat-value">@Model.Count</span>
                </div>
            </div>
            <div class="pm-stat-card">
                <div class="pm-stat-icon success">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="pm-stat-content">
                    <span class="pm-stat-label">Paid</span>
                    <span class="pm-stat-value">@Model.Count(i => i.Status == "Paid")</span>
                </div>
            </div>
            <div class="pm-stat-card">
                <div class="pm-stat-icon warning">
                    <i class="bi bi-clock"></i>
                </div>
                <div class="pm-stat-content">
                    <span class="pm-stat-label">Pending</span>
                    <span class="pm-stat-value">@Model.Count(i => i.Status == "Pending" || i.Status == "Sent")</span>
                </div>
            </div>
            <div class="pm-stat-card">
                <div class="pm-stat-icon danger">
                    <i class="bi bi-exclamation-circle"></i>
                </div>
                <div class="pm-stat-content">
                    <span class="pm-stat-label">Overdue</span>
                    <span class="pm-stat-value">@Model.Count(i => i.Status == "Overdue")</span>
                </div>
            </div>
        </div>

        <!-- Invoices Table -->
        <div class="pm-card">
            <div class="pm-card-header">
                <h4><i class="bi bi-list-ul"></i> All Invoices</h4>
            </div>
            <div class="pm-table-wrapper" style="border: none; border-radius: 0;">
                <table class="pm-table">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Type</th>
                            <th>Issue Date</th>
                            <th>Due Date</th>
                            <th>Amount</th>
                            <th class="pm-text-center">Status</th>
                            <th class="pm-text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var invoice in Model.OrderByDescending(i => i.IssueDate))
                        {
                            var today = DateOnly.FromDateTime(DateTime.Now);

                            var isOverdue =
                            DateOnly.FromDateTime(invoice.DueDate) < today
                            && invoice.Status != "Paid";

                            <tr>
                                <td>
                                    <strong class="pm-text-primary">@invoice.InvoiceNumber</strong>
                                </td>
                                <td>
                                    <span class="pm-badge @GetTypeBadgeClass(invoice.InvoiceType)">
                                        @GetTypeDisplay(invoice.InvoiceType)
                                    </span>
                                </td>
                                <td>
                                    @invoice.IssueDate.ToString("dd/MM/yyyy")
                                </td>
                                <td class="@(isOverdue ? "pm-text-danger pm-font-semibold" : "")">
                                    @invoice.DueDate.ToString("dd/MM/yyyy")
                                    @if (isOverdue)
                                    {
                                        <br/><small class="pm-text-danger">Overdue</small>
                                    }
                                </td>
                                <td>
                                    <strong>@invoice.TotalAmount.ToString("N0") â‚«</strong>
                                </td>
                                <td class="pm-text-center">
                                    <span class="pm-badge @GetStatusBadgeClass(invoice.Status)">
                                        @invoice.Status
                                    </span>
                                </td>
                                <td class="pm-text-center">
                                    <div class="pm-flex pm-justify-center pm-gap-2">
                                        <a asp-action="ExportPdf" asp-route-id="@invoice.InvoiceId" 
                                           class="pm-btn pm-btn-secondary pm-btn-sm" title="Download PDF">
                                            <i class="bi bi-download"></i>
                                            PDF
                                        </a>
                                        @if (invoice.Status != "Paid")
                                        {
                                            <a asp-controller="Payment" asp-action="MakePayment" asp-route-invoiceId="@invoice.InvoiceId" 
                                               class="pm-btn pm-btn-primary pm-btn-sm" title="Pay Now">
                                                <i class="bi bi-credit-card"></i>
                                                Pay
                                            </a>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="pm-card">
            <div class="pm-card-body">
                <div class="pm-empty">
                    <div class="pm-empty-icon">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <h4>No Invoices Yet</h4>
                    <p>You don't have any invoices. Invoices will appear here once you have active leases.</p>
                </div>
            </div>
        </div>
    }
</div>

@functions {
    string GetTypeBadgeClass(string type) => type?.ToLower() switch
    {
        "rent" => "pm-badge-primary",
        "deposit" => "pm-badge-info",
        "maintenance" => "pm-badge-warning",
        _ => "pm-badge-secondary"
    };

    string GetTypeDisplay(string type) => type switch
    {
        "Rent" => "Monthly Rent",
        "Deposit" => "Deposit",
        "Maintenance" => "Maintenance",
        "Utility" => "Utility",
        _ => type
    };

    string GetStatusBadgeClass(string status) => status?.ToLower() switch
    {
        "paid" => "pm-badge-success",
        "pending" => "pm-badge-warning",
        "sent" => "pm-badge-info",
        "overdue" => "pm-badge-danger",
        "cancelled" => "pm-badge-secondary",
        _ => "pm-badge-secondary"
    };
}

<style>
    .pm-page {
        max-width: 1400px;
        margin: 0 auto;
    }

    .pm-page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--pm-space-6);
    }

    .pm-page-title {
        font-size: var(--pm-text-2xl);
        font-weight: var(--pm-font-bold);
        color: var(--pm-text);
        margin: 0 0 var(--pm-space-2);
        display: flex;
        align-items: center;
        gap: var(--pm-space-3);
    }

    .pm-page-title i {
        color: var(--pm-primary);
    }

    .pm-page-subtitle {
        font-size: var(--pm-text-sm);
        color: var(--pm-text-secondary);
        margin: 0;
    }

    .pm-stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--pm-space-5);
        margin-bottom: var(--pm-space-6);
    }

    @@media (max-width: 1024px) {
        .pm-stats-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .pm-stats-row {
            grid-template-columns: 1fr;
        }
    }
</style>

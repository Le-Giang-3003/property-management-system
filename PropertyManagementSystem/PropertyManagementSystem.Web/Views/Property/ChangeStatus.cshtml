@model PropertyManagementSystem.Web.ViewModels.Property.ChangePropertyStatusViewModel

@{
    ViewData["Title"] = "Change Property Status";
    var currentStatus = Model.CurrentStatus ?? "";
}

<div class="container mt-4">
    <h1>Change Property Status</h1>

    <div class="alert alert-info">
        <strong>Property:</strong> @Model.Name
        <br>
        <strong>Current Status:</strong> <span class="badge badge-secondary">@currentStatus</span>
    </div>

    <form asp-action="ChangeStatus" method="post" novalidate>
        <input type="hidden" asp-for="PropertyId" />

        <div class="form-group">
            <label for="NewStatus">New Status <span class="text-danger">*</span></label>
            <select asp-for="NewStatus" id="statusSelect" class="form-control">
                <option value="">-- Select new status --</option>
                <option value="Available" data-color="success" data-label="Available">Available</option>
                <option value="Rented" data-color="primary" data-label="Rented">Rented</option>
                <option value="Maintenance" data-color="warning" data-label="Maintenance">Maintenance</option>
                <option value="Unavailable" data-color="secondary" data-label="Unavailable">Unavailable</option>
            </select>
            <div class="invalid-feedback" id="statusError"></div>
        </div>

        <div class="form-group">
            <div id="statusPreview" class="alert alert-light border">
                <p class="text-muted mb-0">Select status to preview</p>
            </div>
        </div>

        <div class="alert alert-info">
            <strong>Note:</strong> Please select a different status from the current one (<code>@currentStatus</code>) to update.
        </div>

        <div class="form-group">
            <button type="submit" id="submitBtn" class="btn btn-primary" disabled>
                <span id="submitText">Update Status</span>
            </button>
            <a asp-action="Details" asp-route-id="@Model.PropertyId" class="btn btn-secondary">
                Cancel
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function() {
            const select = document.getElementById('statusSelect');
            const preview = document.getElementById('statusPreview');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const statusError = document.getElementById('statusError');
            const currentStatus = '@currentStatus';

            function updateUI() {
                const value = select.value;
                const selectedOption = select.options[select.selectedIndex];

                // Reset styles
                select.classList.remove('is-invalid', 'is-valid');
                statusError.textContent = '';

                if (!value) {
                    // No selection
                    preview.className = 'alert alert-light border';
                    preview.innerHTML = '<p class="text-muted mb-0">Select status to preview</p>';
                    submitBtn.disabled = true;
                    submitBtn.className = 'btn btn-primary';
                }
                else if (value === currentStatus) {
                    // Same as current
                    preview.className = 'alert alert-warning';
                    preview.innerHTML = `
                        <strong>Keep current status:</strong> ${value}
                        <br>
                        <small>Please select a different status from current</small>
                    `;
                    submitBtn.disabled = true;
                    submitBtn.className = 'btn btn-warning';
                    submitText.innerHTML = 'No update needed';
                }
                else {
                    // Valid new status
                    const color = selectedOption.dataset.color;
                    const label = selectedOption.dataset.label || selectedOption.textContent;

                    preview.className = 'alert alert-' + color;
                    preview.innerHTML = `
                        <strong>New Status:</strong> ${value} (${label})
                        <br>
                        <small>Ready to update</small>
                    `;
                    submitBtn.disabled = false;
                    submitBtn.className = 'btn btn-success';
                    submitText.innerHTML = `Update to ${value}`;
                }
            }

            // Event listeners
            select.addEventListener('change', updateUI);

            // Form submit
            document.querySelector('form').addEventListener('submit', function(e) {
                if (submitBtn.disabled) {
                    e.preventDefault();
                    select.classList.add('is-invalid');
                    statusError.textContent = 'Please select a different status from current.';
                    select.focus();
                }
            });

            // Initial load
            updateUI();
        })();
    </script>
}

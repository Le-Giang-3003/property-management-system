@model PropertyManagementSystem.DAL.Entities.RentalApplication
@{
    ViewData["Title"] = "Chi tiết đơn xin thuê";

    var userId = int.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "0");
    var isPropertyOwner = Model.Property?.LandlordId == userId;
    var canUpdate = isPropertyOwner && Model.Status == "Pending";

    // ✅ FIX: Thêm check ExistingLease từ ViewBag
    var hasExistingLease = ViewBag.ExistingLease != null;
    var canCreateLease = isPropertyOwner && Model.Status == "Approved" && !hasExistingLease;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-file-alt"></i> Đơn xin thuê #@Model.ApplicationNumber
                        </h4>
                        @switch (Model.Status)
                        {
                            case "Pending":
                                <span class="badge bg-warning text-dark fs-6">Chờ xử lý</span>
                                break;
                            case "Approved":
                                <span class="badge bg-success fs-6">Đã duyệt</span>
                                break;
                            case "Rejected":
                                <span class="badge bg-danger fs-6">Từ chối</span>
                                break;
                            case "Withdrawn":
                                <span class="badge bg-secondary fs-6">Đã rút</span>
                                break;
                        }
                    </div>
                </div>

                <div class="card-body">
                    <!-- THÔNG TIN TỔNG QUAN -->
                    <div class="alert alert-light border">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">Ngày gửi đơn</small>
                                <div><strong>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Ngày dự kiến chuyển vào</small>
                                <div><strong>@Model.DesiredMoveInDate.ToString("dd/MM/yyyy")</strong></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Số người ở</small>
                                <div><strong>@Model.NumberOfOccupants người</strong></div>
                            </div>
                        </div>
                    </div>

                    <!-- THÔNG TIN BẤT ĐỘNG SẢN -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-home"></i> Thông tin bất động sản</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Tên:</strong> @Model.Property?.Name</p>
                            <p><strong>Địa chỉ:</strong> @Model.Property?.Address</p>
                            <p><strong>Loại:</strong> @Model.Property?.PropertyType</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Giá thuê:</strong> <span class="text-danger fs-5">@Model.Property?.RentAmount.ToString("N0") VNĐ/tháng</span></p>
                            <p><strong>Diện tích:</strong> @Model.Property?.SquareFeet m²</p>
                            <p><strong>Phòng ngủ/WC:</strong> @Model.Property?.Bedrooms / @Model.Property?.Bathrooms</p>
                        </div>
                    </div>

                    <!-- THÔNG TIN NGƯỜI THUÊ -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-user"></i> Thông tin người thuê</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Họ tên:</strong> @Model.Applicant?.FullName</p>
                            <p><strong>Email:</strong> @Model.Applicant?.Email</p>
                            <p><strong>Số điện thoại:</strong> @Model.Applicant?.PhoneNumber</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Ngày sinh:</strong> @Model.Applicant?.DateOfBirth?.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>

                    <!-- THÔNG TIN VIỆC LÀM -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-briefcase"></i> Thông tin việc làm</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p>
                                <strong>Tình trạng việc làm:</strong>
                                <span class="badge bg-info">@Model.EmploymentStatus</span>
                            </p>
                            <p><strong>Nơi làm việc:</strong> @(Model.Employer ?? "Không cung cấp")</p>
                        </div>
                        <div class="col-md-6">
                            <p>
                                <strong>Thu nhập hàng tháng:</strong>
                                @if (Model.MonthlyIncome.HasValue)
                                {
                                    <span class="text-success fs-5">@Model.MonthlyIncome.Value.ToString("N0") VNĐ</span>
                                }
                                else
                                {
                                    <span class="text-muted">Không cung cấp</span>
                                }
                            </p>
                        </div>
                    </div>

                    <!-- THÔNG TIN NƠI Ở TRƯỚC -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-map-marker-alt"></i> Thông tin nơi ở trước đây</h5>
                    <div class="row mb-4">
                        <div class="col-md-12 mb-2">
                            <p><strong>Địa chỉ cũ:</strong> @(Model.PreviousAddress ?? "Không cung cấp")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Chủ nhà trước:</strong> @(Model.PreviousLandlord ?? "Không cung cấp")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>SĐT chủ nhà trước:</strong> @(Model.PreviousLandlordPhone ?? "Không cung cấp")</p>
                        </div>
                    </div>

                    <!-- THÔNG TIN THÚ CƯNG -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-paw"></i> Thông tin thú cưng</h5>
                    <div class="mb-4">
                        <p>
                            <strong>Có nuôi thú cưng:</strong>
                            @if (Model.HasPets)
                            {
                                <span class="badge bg-warning text-dark">Có</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Không</span>
                            }
                        </p>
                        @if (Model.HasPets && !string.IsNullOrEmpty(Model.PetDetails))
                        {
                            <p><strong>Chi tiết:</strong> @Model.PetDetails</p>
                        }
                    </div>

                    <!-- GHI CHÚ -->
                    @if (!string.IsNullOrEmpty(Model.AdditionalNotes))
                    {
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-sticky-note"></i> Ghi chú thêm</h5>
                        <div class="mb-4">
                            <div class="alert alert-secondary">
                                @Model.AdditionalNotes
                            </div>
                        </div>
                    }

                    <!-- THÔNG TIN XÉT DUYỆT -->
                    @if (Model.ReviewedAt.HasValue)
                    {
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-check-circle"></i> Thông tin xét duyệt</h5>
                        <div class="mb-4">
                            <p><strong>Người xét duyệt:</strong> @Model.ReviewedByUser?.FullName</p>
                            <p><strong>Thời gian xét duyệt:</strong> @Model.ReviewedAt.Value.ToString("dd/MM/yyyy HH:mm")</p>

                            @if (Model.Status == "Rejected" && !string.IsNullOrEmpty(Model.RejectionReason))
                            {
                                <div class="alert alert-danger">
                                    <strong><i class="fas fa-exclamation-triangle"></i> Lý do từ chối:</strong><br />
                                    @Model.RejectionReason
                                </div>
                            }
                        </div>
                    }

                    <!-- ✅ HIỂN THỊ HỢP ĐỒNG ĐÃ TẠO (NẾU CÓ) -->
                    @if (hasExistingLease && ViewBag.ExistingLease != null)
                    {
                        <div class="card border-success mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle"></i> Hợp đồng đã được tạo
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong><i class="fas fa-file-contract text-primary"></i> Mã hợp đồng:</strong>
                                            <span class="badge bg-primary fs-6">@ViewBag.ExistingLease.LeaseNumber</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="fas fa-calendar-alt text-info"></i> Thời gian:</strong>
                                            @ViewBag.ExistingLease.StartDate.ToString("dd/MM/yyyy")
                                            → @ViewBag.ExistingLease.EndDate.ToString("dd/MM/yyyy")
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong><i class="fas fa-info-circle text-warning"></i> Trạng thái:</strong>
                                            @if (ViewBag.ExistingLease.Status == "Draft")
                                            {
                                                <span class="badge bg-secondary">Nháp</span>
                                            }
                                            else if (ViewBag.ExistingLease.Status == "Active")
                                            {
                                                <span class="badge bg-success">Đang hiệu lực</span>
                                            }
                                            else if (ViewBag.ExistingLease.Status == "Expired")
                                            {
                                                <span class="badge bg-danger">Đã hết hạn</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-info">@ViewBag.ExistingLease.Status</span>
                                            }
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="fas fa-money-bill-wave text-success"></i> Tiền thuê:</strong>
                                            @ViewBag.ExistingLease.MonthlyRent.ToString("N0") VNĐ/tháng
                                        </p>
                                    </div>
                                </div>

                                <hr>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a asp-controller="Lease" asp-action="Details"
                                       asp-route-id="@ViewBag.ExistingLease.LeaseId"
                                       class="btn btn-primary">
                                        <i class="fas fa-eye"></i> Xem chi tiết hợp đồng
                                    </a>

                                    @if (ViewBag.ExistingLease.Status == "Draft")
                                    {
                                        <a asp-controller="Lease" asp-action="Edit"
                                           asp-route-id="@ViewBag.ExistingLease.LeaseId"
                                           class="btn btn-warning">
                                            <i class="fas fa-edit"></i> Chỉnh sửa hợp đồng
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- ✅ NÚT TẠO HỢP ĐỒNG - CHỈ HIỆN KHI CHƯA CÓ LEASE -->
                    @if (canCreateLease)
                    {
                        <div class="card bg-success text-white shadow-lg mt-4 border-0">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-file-contract fa-3x"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title mb-1">
                                            <i class="fas fa-check-circle"></i> Đơn đã được duyệt!
                                        </h5>
                                        <p class="mb-0">
                                            Bạn có thể tạo hợp đồng thuê chính thức cho <strong>@Model.Applicant?.FullName</strong>
                                        </p>
                                    </div>
                                </div>

                                <a asp-controller="Lease" asp-action="Create" asp-route-applicationId="@Model.ApplicationId"
                                   class="btn btn-light btn-lg w-100 shadow">
                                    <i class="fas fa-file-contract"></i> <strong>Tạo hợp đồng thuê ngay</strong>
                                </a>
                            </div>
                        </div>
                    }

                    <!-- ✅ FORM XÉT DUYỆT - CHỈ CHO PROPERTY OWNER -->
                    @if (canUpdate)
                    {
                        <div class="card bg-light mt-4 shadow">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-tasks"></i> Xét duyệt đơn</h5>
                                <p class="text-muted mb-3">
                                    Sau khi duyệt, bạn có thể tạo hợp đồng thuê chính thức.
                                </p>

                                <div class="row">
                                    <!-- APPROVE -->
                                    <div class="col-md-6 mb-3">
                                        <form asp-action="Approve" method="post" onsubmit="return confirm('Bạn có chắc muốn DUYỆT đơn này không?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@Model.ApplicationId" />
                                            <button type="submit" class="btn btn-success w-100 btn-lg">
                                                <i class="fas fa-check-circle"></i> Chấp nhận đơn
                                            </button>
                                        </form>
                                    </div>

                                    <!-- REJECT -->
                                    <div class="col-md-6 mb-3">
                                        <button type="button" class="btn btn-danger w-100 btn-lg" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                            <i class="fas fa-times-circle"></i> Từ chối đơn
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    @if (!isPropertyOwner && Model.Status == "Pending")
                    {
                        <div class="alert alert-warning mt-4">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Lưu ý:</strong> Chỉ chủ nhà của bất động sản này mới có thể xét duyệt đơn.
                        </div>
                    }

                    <!-- NAVIGATION BUTTONS -->
                    <div class="mt-4 d-flex gap-2 flex-wrap">
                        @if (isPropertyOwner)
                        {
                            <a asp-action="ByProperty" asp-route-propertyId="@Model.PropertyId" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Đơn của BĐS này
                            </a>
                        }
                        else if (Model.ApplicantId == userId)
                        {
                            <a asp-action="MyApplications" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Đơn của tôi
                            </a>
                        }
                        else
                        {
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Danh sách đơn
                            </a>
                        }

                        <a asp-controller="Property" asp-action="Details" asp-route-id="@Model.PropertyId" class="btn btn-outline-primary">
                            <i class="fas fa-home"></i> Xem BĐS
                        </a>

                        @if (isPropertyOwner && Model.Status == "Approved")
                        {
                            <a asp-controller="Lease" asp-action="Index" class="btn btn-outline-success">
                                <i class="fas fa-file-contract"></i> Quản lý hợp đồng
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL TỪ CHỐI -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Reject" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.ApplicationId" />

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-times-circle"></i> Từ chối đơn xin thuê</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Bạn đang từ chối đơn xin thuê <strong>@Model.ApplicationNumber</strong>
                    </div>

                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">
                            Lý do từ chối<span class="text-danger">*</span>
                        </label>
                        <textarea name="rejectionReason" id="rejectionReason" class="form-control" rows="4"
                                  required placeholder="Vui lòng nêu rõ lý do từ chối để người thuê hiểu..."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times-circle"></i> Xác nhận từ chối
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

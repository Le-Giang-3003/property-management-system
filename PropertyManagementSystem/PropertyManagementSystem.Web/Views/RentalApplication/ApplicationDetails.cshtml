@model PropertyManagementSystem.DAL.Entities.RentalApplication
@{
    ViewData["Title"] = "Application Details";
    Layout = "_AuthLayout";
    
    // ✅ VALIDATE: Chỉ cho approve/reject nếu Property thuộc về user này
    var userId = 0;
    var userIdClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    int.TryParse(userIdClaim, out userId);
    var isPropertyOwner = Model.Property?.LandlordId == userId;
    var canUpdate = isPropertyOwner && Model.Status == "Pending";

    // ✅ FIX: Thêm check ExistingLease từ ViewBag
    var hasExistingLease = ViewBag.ExistingLease != null;
    var canCreateLease = isPropertyOwner && Model.Status == "Approved" && !hasExistingLease;
    
    // Set portal mode based on whether user owns the property
    ViewData["PortalMode"] = isPropertyOwner ? "Landlord" : "Tenant";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-file-alt"></i> Application #@Model.ApplicationNumber
                        </h4>
                        @switch (Model.Status)
                        {
                            case "Pending":
                                <span class="badge bg-warning text-dark fs-6">Pending</span>
                                break;
                            case "Approved":
                                <span class="badge bg-success fs-6">Approved</span>
                                break;
                            case "Rejected":
                                <span class="badge bg-danger fs-6">Rejected</span>
                                break;
                            case "Withdrawn":
                                <span class="badge bg-secondary fs-6">Withdrawn</span>
                                break;
                        }
                    </div>
                </div>

                <div class="card-body">
                    <!-- OVERVIEW INFORMATION -->
                    <div class="alert alert-light border">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">Submission Date</small>
                                <div><strong>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Desired Move-in Date</small>
                                <div><strong>@Model.DesiredMoveInDate.ToString("dd/MM/yyyy")</strong></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Number of Occupants</small>
                                <div><strong>@Model.NumberOfOccupants people</strong></div>
                            </div>
                        </div>
                    </div>

                    <!-- PROPERTY INFORMATION -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-home"></i> Property Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> @Model.Property?.Name</p>
                            <p><strong>Address:</strong> @Model.Property?.Address</p>
                            <p><strong>Type:</strong> @Model.Property?.PropertyType</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Rent:</strong> <span class="text-danger fs-5">$@Model.Property?.RentAmount.ToString("N0")/month</span></p>
                            <p><strong>Area:</strong> @Model.Property?.SquareFeet sqft</p>
                            <p><strong>Bedrooms/Bathrooms:</strong> @Model.Property?.Bedrooms / @Model.Property?.Bathrooms</p>
                        </div>
                    </div>

                    <!-- APPLICANT INFORMATION -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-user"></i> Applicant Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Full Name:</strong> @Model.Applicant?.FullName</p>
                            <p><strong>Email:</strong> @Model.Applicant?.Email</p>
                            <p><strong>Phone Number:</strong> @Model.Applicant?.PhoneNumber</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Date of Birth:</strong> @Model.Applicant?.DateOfBirth?.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>

                    <!-- EMPLOYMENT INFORMATION -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-briefcase"></i> Employment Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p>
                                <strong>Employment Status:</strong>
                                <span class="badge bg-info">@Model.EmploymentStatus</span>
                            </p>
                            <p><strong>Employer:</strong> @(Model.Employer ?? "Not provided")</p>
                        </div>
                        <div class="col-md-6">
                            <p>
                                <strong>Monthly Income:</strong>
                                @if (Model.MonthlyIncome.HasValue)
                                {
                                    <span class="text-success fs-5">$@Model.MonthlyIncome.Value.ToString("N0")</span>
                                }
                                else
                                {
                                    <span class="text-muted">Not provided</span>
                                }
                            </p>
                        </div>
                    </div>

                    <!-- PREVIOUS RESIDENCE INFORMATION -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-map-marker-alt"></i> Previous Residence Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-12 mb-2">
                            <p><strong>Previous Address:</strong> @(Model.PreviousAddress ?? "Not provided")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Previous Landlord:</strong> @(Model.PreviousLandlord ?? "Not provided")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Previous Landlord Phone:</strong> @(Model.PreviousLandlordPhone ?? "Not provided")</p>
                        </div>
                    </div>

                    <!-- PET INFORMATION -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-paw"></i> Pet Information</h5>
                    <div class="mb-4">
                        <p>
                            <strong>Has Pets:</strong>
                            @if (Model.HasPets)
                            {
                                <span class="badge bg-warning text-dark">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-success">No</span>
                            }
                        </p>
                        @if (Model.HasPets && !string.IsNullOrEmpty(Model.PetDetails))
                        {
                            <p><strong>Details:</strong> @Model.PetDetails</p>
                        }
                    </div>

                    <!-- NOTES -->
                    @if (!string.IsNullOrEmpty(Model.AdditionalNotes))
                    {
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-sticky-note"></i> Additional Notes</h5>
                        <div class="mb-4">
                            <div class="alert alert-secondary">
                                @Model.AdditionalNotes
                            </div>
                        </div>
                    }

                    <!-- REVIEW INFORMATION -->
                    @if (Model.ReviewedAt.HasValue)
                    {
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-check-circle"></i> Review Information</h5>
                        <div class="mb-4">
                            <p><strong>Reviewed By:</strong> @Model.ReviewedByUser?.FullName</p>
                            <p><strong>Review Time:</strong> @Model.ReviewedAt.Value.ToString("dd/MM/yyyy HH:mm")</p>

                            @if (Model.Status == "Rejected" && !string.IsNullOrEmpty(Model.RejectionReason))
                            {
                                <div class="alert alert-danger">
                                    <strong><i class="fas fa-exclamation-triangle"></i> Rejection Reason:</strong><br />
                                    @Model.RejectionReason
                                </div>
                            }
                        </div>
                    }

                    <!-- ✅ DISPLAY EXISTING LEASE (IF ANY) -->
                    @if (hasExistingLease && ViewBag.ExistingLease != null)
                    {
                        <div class="card border-success mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle"></i> Lease Created
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong><i class="fas fa-file-contract text-primary"></i> Lease Number:</strong>
                                            <span class="badge bg-primary fs-6">@ViewBag.ExistingLease.LeaseNumber</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="fas fa-calendar-alt text-info"></i> Duration:</strong>
                                            @ViewBag.ExistingLease.StartDate.ToString("dd/MM/yyyy")
                                            → @ViewBag.ExistingLease.EndDate.ToString("dd/MM/yyyy")
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong><i class="fas fa-info-circle text-warning"></i> Status:</strong>
                                            @if (ViewBag.ExistingLease.Status == "Draft")
                                            {
                                                <span class="badge bg-secondary">Draft</span>
                                            }
                                            else if (ViewBag.ExistingLease.Status == "Active")
                                            {
                                                <span class="badge bg-success">Active</span>
                                            }
                                            else if (ViewBag.ExistingLease.Status == "Expired")
                                            {
                                                <span class="badge bg-danger">Expired</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-info">@ViewBag.ExistingLease.Status</span>
                                            }
                                        </p>
                                        <p class="mb-2">
                                            <strong><i class="fas fa-money-bill-wave text-success"></i> Rent:</strong>
                                            $@ViewBag.ExistingLease.MonthlyRent.ToString("N0")/month
                                        </p>
                                    </div>
                                </div>

                                <hr>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a asp-controller="Lease" asp-action="Details"
                                       asp-route-id="@ViewBag.ExistingLease.LeaseId"
                                       class="btn btn-primary">
                                        <i class="fas fa-eye"></i> View Lease Details
                                    </a>

                                    @if (ViewBag.ExistingLease.Status == "Draft")
                                    {
                                        <a asp-controller="Lease" asp-action="Edit"
                                           asp-route-id="@ViewBag.ExistingLease.LeaseId"
                                           class="btn btn-warning">
                                            <i class="fas fa-edit"></i> Edit Lease
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- ✅ CREATE LEASE BUTTON - ONLY SHOW WHEN NO LEASE EXISTS -->
                    @if (canCreateLease)
                    {
                        <div class="card bg-success text-white shadow-lg mt-4 border-0">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-file-contract fa-3x"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title mb-1">
                                            <i class="fas fa-check-circle"></i> Application Approved!
                                        </h5>
                                        <p class="mb-0">
                                            You can create an official lease for <strong>@Model.Applicant?.FullName</strong>
                                        </p>
                                    </div>
                                </div>

                                <a asp-controller="Lease" asp-action="Create" asp-route-applicationId="@Model.ApplicationId"
                                   class="btn btn-light btn-lg w-100 shadow">
                                    <i class="fas fa-file-contract"></i> <strong>Create Lease Now</strong>
                                </a>
                            </div>
                        </div>
                    }

                    <!-- ✅ REVIEW FORM - ONLY FOR PROPERTY OWNER -->
                    @if (canUpdate)
                    {
                        <div class="card bg-light mt-4 shadow">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-tasks"></i> Review Application</h5>
                                <p class="text-muted mb-3">
                                    After approval, you can create an official lease.
                                </p>

                                <div class="row">
                                    <!-- APPROVE -->
                                    <div class="col-md-6 mb-3">
                                        <form asp-action="Approve" method="post" onsubmit="return confirm('Are you sure you want to APPROVE this application?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@Model.ApplicationId" />
                                            <button type="submit" class="btn btn-success w-100 btn-lg">
                                                <i class="fas fa-check-circle"></i> Approve Application
                                            </button>
                                        </form>
                                    </div>

                                    <!-- REJECT -->
                                    <div class="col-md-6 mb-3">
                                        <button type="button" class="btn btn-danger w-100 btn-lg" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                            <i class="fas fa-times-circle"></i> Reject Application
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    @if (!isPropertyOwner && Model.Status == "Pending")
                    {
                        <div class="alert alert-warning mt-4">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Note:</strong> Only the property owner can review this application.
                        </div>
                    }

                    <!-- NAVIGATION BUTTONS -->
                    <div class="mt-4 d-flex gap-2 flex-wrap">
                        @if (isPropertyOwner)
                        {
                            <a asp-action="ByProperty" asp-route-propertyId="@Model.PropertyId" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Property Applications
                            </a>
                        }
                        else if (Model.ApplicantId == userId)
                        {
                            <a asp-action="MyApplications" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> My Applications
                            </a>
                        }
                        else
                        {
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Application List
                            </a>
                        }

                        <a asp-controller="Property" asp-action="Details" asp-route-id="@Model.PropertyId" class="btn btn-outline-primary">
                            <i class="fas fa-home"></i> View Property
                        </a>

                        @if (isPropertyOwner && Model.Status == "Approved")
                        {
                            <a asp-controller="Lease" asp-action="Index" class="btn btn-outline-success">
                                <i class="fas fa-file-contract"></i> Manage Leases
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- REJECTION MODAL -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Reject" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.ApplicationId" />

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-times-circle"></i> Reject Application</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        You are rejecting application <strong>@Model.ApplicationNumber</strong>
                    </div>

                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">
                            Rejection Reason<span class="text-danger">*</span>
                        </label>
                        <textarea name="rejectionReason" id="rejectionReason" class="form-control" rows="4"
                                  required placeholder="Please provide a clear reason for the applicant..."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times-circle"></i> Confirm Rejection
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@model IEnumerable<PropertyManagementSystem.DAL.Entities.Lease>
@{
    ViewData["Title"] = "Lease History";
    var propertyName = ViewBag.PropertyName as string;
}

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-history"></i> Lease History</h2>
            @if (!string.IsNullOrEmpty(propertyName))
            {
                <p class="text-muted mb-0">
                    <i class="fas fa-building"></i> <strong>@propertyName</strong>
                </p>
            }
        </div>
        <div>
            <a asp-controller="Property" asp-action="Details" asp-route-id="@ViewBag.PropertyId"
               class="btn btn-outline-secondary">
                <i class="fas fa-building"></i> View Property
            </a>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No lease history</h4>
                <p class="text-muted">This property has never been rented</p>
            </div>
        </div>
    }
    else
    {
        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white shadow-sm">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@Model.Count()</h3>
                        <small>Total Leases</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white shadow-sm">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@Model.Count(l => l.Status == "Active")</h3>
                        <small>Active</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white shadow-sm">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@Model.Count(l => l.Status == "Expired")</h3>
                        <small>Expired</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-white shadow-sm">
                    <div class="card-body text-center">
                        <h3 class="mb-0">@Model.Count(l => l.Status == "Terminated")</h3>
                        <small>Terminated</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Timeline</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    @foreach (var lease in Model.OrderByDescending(l => l.StartDate))
                    {
                        <div class="card mb-3 shadow-sm border-start border-5
                                     @(lease.Status == "Active" ? "border-success" :
                                                            lease.Status == "Expired" ? "border-danger" :
                                                            lease.Status == "Terminated" ? "border-dark" : "border-secondary")">
                            <div class="card-body">
                                <div class="row">
                                    <!-- Left: Info -->
                                    <div class="col-md-8">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h5 class="mb-0">
                                                <i class="fas fa-file-contract text-primary"></i>
                                                @lease.LeaseNumber
                                            </h5>
                                            @switch (lease.Status)
                                            {
                                                case "Draft":
                                                    <span class="badge bg-secondary">Draft</span>
                                                    break;
                                                case "PendingSignature":
                                                    <span class="badge bg-warning text-dark">Pending Signature</span>
                                                    break;
                                                case "Active":
                                                    <span class="badge bg-success">Active</span>
                                                    break;
                                                case "Expired":
                                                    <span class="badge bg-danger">Expired</span>
                                                    break;
                                                case "Terminated":
                                                    <span class="badge bg-dark">Terminated</span>
                                                    break;
                                            }
                                        </div>

                                        <div class="row mb-2">
                                            <div class="col-sm-6">
                                                <p class="mb-1">
                                                    <i class="fas fa-user text-muted"></i>
                                                    <strong>Tenant:</strong> @lease.Tenant?.FullName
                                                </p>
                                                <p class="mb-1">
                                                    <i class="fas fa-phone text-muted"></i>
                                                    @lease.Tenant?.PhoneNumber
                                                </p>
                                            </div>
                                            <div class="col-sm-6">
                                                <p class="mb-1">
                                                    <i class="fas fa-calendar text-muted"></i>
                                                    <strong>Duration:</strong>
                                                    @lease.StartDate.ToString("dd/MM/yyyy") - @lease.EndDate.ToString("dd/MM/yyyy")
                                                </p>
                                                <p class="mb-1">
                                                    <i class="fas fa-hourglass-half text-muted"></i>
                                                    <strong>Term:</strong>
                                                    @{
                                                        var months = ((lease.EndDate.Year - lease.StartDate.Year) * 12) +
                                                        lease.EndDate.Month - lease.StartDate.Month;
                                                    }
                                                    @months months
                                                </p>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-sm-6">
                                                <p class="mb-0">
                                                    <i class="fas fa-money-bill-wave text-success"></i>
                                                    <strong>Rent:</strong>
                                                    <span class="text-danger fw-bold">$@lease.MonthlyRent.ToString("N0")/month</span>
                                                </p>
                                            </div>
                                            <div class="col-sm-6">
                                                <p class="mb-0">
                                                    <i class="fas fa-shield-alt text-warning"></i>
                                                    <strong>Deposit:</strong>
                                                    <span class="text-warning fw-bold">$@lease.SecurityDeposit.ToString("N0")</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right: Actions & Extra Info -->
                                    <div class="col-md-4 text-end">
                                        <div class="mb-3">
                                            <small class="text-muted d-block">Created</small>
                                            <strong>@lease.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong>
                                        </div>

                                        <div class="mb-3">
                                            <small class="text-muted d-block">Total Contract Value</small>
                                            <h5 class="text-primary mb-0">
                                                $@((lease.MonthlyRent * months).ToString("N0"))
                                            </h5>
                                        </div>

                                        <a asp-action="Details" asp-route-id="@lease.LeaseId"
                                           class="btn btn-primary w-100">
                                            <i class="fas fa-eye"></i> View Details
                                        </a>
                                    </div>
                                </div>

                                <!-- Additional Info for Terminated -->
                                @if (lease.Status == "Terminated" && !string.IsNullOrEmpty(lease.TerminationReason))
                                {
                                    <div class="alert alert-dark mt-3 mb-0">
                                        <small>
                                            <strong><i class="fas fa-ban"></i> Termination Reason:</strong>
                                            @lease.TerminationReason
                                        </small>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <small class="text-muted">Total Actual Revenue</small>
                        <h4 class="text-success">
                            @{
                                var totalRevenue = Model.Where(l => l.Status == "Active" || l.Status == "Expired" || l.Status == "Terminated")
                                .Sum(l =>
                                {
                                    var m = ((l.EndDate.Year - l.StartDate.Year) * 12) +
                                                    l.EndDate.Month - l.StartDate.Month;
                                    return l.MonthlyRent * m;
                                });
                            }
                            $@totalRevenue.ToString("N0")
                        </h4>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Total Deposits Received</small>
                        <h4 class="text-warning">
                            $@Model.Sum(l => l.SecurityDeposit).ToString("N0")
                        </h4>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Average Rent</small>
                        <h4 class="text-primary">
                            @{
                                var avgRent = Model.Any() ? Model.Average(l => l.MonthlyRent) : 0;
                            }
                            $@avgRent.ToString("N0")
                        </h4>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Avg Duration</small>
                        <h4 class="text-info">
                            @{
                                var avgMonths = Model.Any() ? Model.Average(l =>
                                ((l.EndDate.Year - l.StartDate.Year) * 12) +
                                l.EndDate.Month - l.StartDate.Month) : 0;
                            }
                            @Math.Round(avgMonths, 1) months
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .timeline {
        position: relative;
    }
</style>

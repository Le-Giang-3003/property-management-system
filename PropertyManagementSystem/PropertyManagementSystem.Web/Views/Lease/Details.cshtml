@model PropertyManagementSystem.DAL.Entities.Lease
@{
    ViewData["Title"] = "Chi tiết hợp đồng";
    var isLandlord = ViewBag.IsLandlord ?? false;
    var isTenant = ViewBag.IsTenant ?? false;
    var canSign = ViewBag.CanSign ?? false;
    var signatures = ViewBag.Signatures as IEnumerable<PropertyManagementSystem.BLL.DTOs.Lease.LeaseSignatureDto>;
    var hasLandlordSigned = ViewBag.HasLandlordSigned ?? false;
    var hasTenantSigned = ViewBag.HasTenantSigned ?? false;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-file-contract"></i> Hợp đồng @Model.LeaseNumber
                        </h4>
                        @switch (Model.Status)
                        {
                            case "Draft":
                                <span class="badge bg-secondary fs-6">
                                    <i class="fas fa-file-alt"></i> Chờ ký
                                </span>
                                break;
                            case "Active":
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check-circle"></i> Đang hiệu lực
                                </span>
                                break;
                            case "Expired":
                                <span class="badge bg-danger fs-6">
                                    <i class="fas fa-calendar-times"></i> Hết hạn
                                </span>
                                break;
                            case "Terminated":
                                <span class="badge bg-dark fs-6">
                                    <i class="fas fa-ban"></i> Đã chấm dứt
                                </span>
                                break;
                        }
                    </div>
                </div>
                <div class="card-body">
                    <!-- ✅ THÔNG BÁO KÝ HỢP ĐỒNG - CHỈ HIỆN KHI DRAFT -->
                    @if (Model.Status == "Draft")
                    {
                        <div class="alert alert-warning border-warning mb-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-pen-nib fa-3x text-warning"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="alert-heading mb-2">
                                        <i class="fas fa-exclamation-triangle"></i> Hợp đồng chưa hoàn tất
                                    </h5>

                                    <!-- Trạng thái ký -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            @if (hasLandlordSigned)
                                            {
                                                <span class="badge bg-success fs-6">
                                                    <i class="fas fa-check-circle"></i> Chủ nhà đã ký
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary fs-6">
                                                    <i class="fas fa-clock"></i> Chờ chủ nhà ký
                                                </span>
                                            }
                                        </div>
                                        <div class="col-md-6">
                                            @if (hasTenantSigned)
                                            {
                                                <span class="badge bg-success fs-6">
                                                    <i class="fas fa-check-circle"></i> Người thuê đã ký
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary fs-6">
                                                    <i class="fas fa-clock"></i> Chờ người thuê ký
                                                </span>
                                            }
                                        </div>
                                    </div>

                                    <!-- ✅ LOGIC HIỂN THỊ NÚT KÝ HOẶC THÔNG BÁO -->
                                    @if (canSign)
                                    {
                                        <a asp-action="Sign" asp-route-id="@Model.LeaseId"
                                           class="btn btn-success btn-lg">
                                            <i class="fas fa-pen-nib"></i> Ký hợp đồng ngay
                                        </a>
                                        <p class="mb-0 mt-2 text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Vui lòng ký hợp đồng để hoàn tất thủ tục.
                                        </p>
                                    }
                                    else
                                    {
                                        @if (isLandlord && hasLandlordSigned)
                                        {
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-check-circle"></i>
                                                <strong>Bạn đã ký hợp đồng.</strong> Đang chờ người thuê ký để hợp đồng có hiệu lực.
                                            </div>
                                        }
                                        else if (isTenant && hasTenantSigned)
                                        {
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-check-circle"></i>
                                                <strong>Bạn đã ký hợp đồng.</strong> Đang chờ chủ nhà ký để hợp đồng có hiệu lực.
                                            </div>
                                        }
                                        else if (!isLandlord && !isTenant)
                                        {
                                            <div class="alert alert-secondary mb-0">
                                                <i class="fas fa-eye"></i>
                                                Bạn không có quyền ký hợp đồng này.
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    else if (Model.Status == "Active")
                    {
                        <div class="alert alert-success border-success mb-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-check-circle fa-3x text-success"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="alert-heading mb-2">
                                        <i class="fas fa-check-double"></i> Hợp đồng đã có hiệu lực pháp lý
                                    </h5>
                                    @if (Model.SignedDate.HasValue)
                                    {
                                        <p class="mb-0">
                                            <i class="fas fa-calendar-check"></i>
                                            Hợp đồng được ký đầy đủ vào ngày <strong>@Model.SignedDate.Value.ToString("dd/MM/yyyy HH:mm")</strong>
                                        </p>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Thông tin tổng quan -->
                    <div class="alert alert-light border mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Ngày tạo</small>
                                <div><strong>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Thời hạn hợp đồng</small>
                                <div>
                                    <strong>
                                        @Model.StartDate.ToString("dd/MM/yyyy") - @Model.EndDate.ToString("dd/MM/yyyy")
                                    </strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Ngày thanh toán</small>
                                <div><strong>Ngày @Model.PaymentDueDay hàng tháng</strong></div>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Tự động gia hạn</small>
                                <div>
                                    @if (Model.AutoRenew)
                                    {
                                        <span class="badge bg-success">Có</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Không</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thông tin bất động sản -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-home"></i> Thông tin bất động sản</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Tên:</strong> @Model.Property?.Name</p>
                            <p><strong>Địa chỉ:</strong> @Model.Property?.Address</p>
                            <p><strong>Loại:</strong> @Model.Property?.PropertyType</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Diện tích:</strong> @Model.Property?.SquareFeet m²</p>
                            <p><strong>Phòng ngủ/WC:</strong> @Model.Property?.Bedrooms / @Model.Property?.Bathrooms</p>
                            <p>
                                <a asp-controller="Property" asp-action="Details" asp-route-id="@Model.PropertyId"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> Xem bất động sản
                                </a>
                            </p>
                        </div>
                    </div>

                    <!-- Thông tin người thuê -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-user"></i> Thông tin người thuê</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Họ tên:</strong> @Model.Tenant?.FullName</p>
                            <p><strong>Email:</strong> @Model.Tenant?.Email</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Số điện thoại:</strong> @Model.Tenant?.PhoneNumber</p>
                            @if (Model.ApplicationId.HasValue)
                            {
                                <p>
                                    <strong>Đơn xin thuê:</strong>
                                    <a asp-controller="RentalApplication" asp-action="Details" asp-route-id="@Model.ApplicationId">
                                        @Model.RentalApplication?.ApplicationNumber
                                    </a>
                                </p>
                            }
                        </div>
                    </div>

                    <!-- Thông tin tài chính -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-dollar-sign"></i> Thông tin tài chính</h5>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted">Tiền thuê hàng tháng</small>
                                    <h3 class="text-danger mb-0">@Model.MonthlyRent.ToString("N0") VNĐ</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted">Tiền đặt cọc</small>
                                    <h3 class="text-success mb-0">@Model.SecurityDeposit.ToString("N0") VNĐ</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <small class="text-muted">Tần suất thanh toán</small>
                                    <h3 class="mb-0">@Model.PaymentFrequency</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Điều khoản -->
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-file-alt"></i> Điều khoản hợp đồng</h5>
                    <div class="mb-4">
                        <pre class="bg-light p-3 rounded" style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">@Model.Terms</pre>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.SpecialConditions))
                    {
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-star"></i> Điều kiện đặc biệt</h5>
                        <div class="mb-4">
                            <div class="alert alert-info">
                                @Model.SpecialConditions
                            </div>
                        </div>
                    }

                    <!-- Buttons -->
                    <div class="mt-4 d-flex gap-2 flex-wrap">
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>

                        @* ✅ SỬA: Chỉ hiện nút Edit khi chưa có ai ký *@
                        @if (Model.Status == "Draft" && isLandlord && !hasLandlordSigned && !hasTenantSigned)
                        {
                            <a asp-action="Edit" asp-route-id="@Model.LeaseId" class="btn btn-warning">
                                <i class="fas fa-edit"></i> Chỉnh sửa
                            </a>
                        }

                        @if (canSign)
                        {
                            <a asp-action="Sign" asp-route-id="@Model.LeaseId" class="btn btn-success btn-lg">
                                <i class="fas fa-pen-nib"></i> Ký hợp đồng
                            </a>
                        }

                        @if (Model.Status == "Active")
                        {
                            <a asp-action="DownloadPdf" asp-route-id="@Model.LeaseId" class="btn btn-info">
                                <i class="fas fa-file-pdf"></i> Tải PDF
                            </a>
                        }

                        @if (isLandlord)
                        {
                            <a asp-action="History" asp-route-propertyId="@Model.PropertyId" class="btn btn-outline-info">
                                <i class="fas fa-history"></i> Lịch sử HĐ
                            </a>
                        }
                    </div>


                    <!-- ✅ CHỮ KÝ - KHÔNG HIỆN IP -->
                    @if (signatures != null && signatures.Any())
                    {
                        <hr class="my-4">

                        <h5><i class="fas fa-signature"></i> Chữ ký xác nhận</h5>

                        @foreach (var sig in signatures.OrderBy(s => s.SignedAt))
                        {
                            <div class="mb-3 p-3 border rounded">
                                <p class="mb-1">
                                    <strong>@(sig.SignerRole == "Landlord" ? "Chủ nhà" : "Người thuê"):</strong>
                                    @sig.UserName
                                </p>
                                <p class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> @sig.SignedAt.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </p>

                                @if (!string.IsNullOrEmpty(sig.SignatureData))
                                {
                                    <img src="@sig.SignatureData"
                                         alt="Chữ ký"
                                         style="max-width: 200px; border: 1px solid #ddd; padding: 5px; background: white;" />
                                }
                            </div>
                        }
                    }

                </div>
            </div>
        </div>
    </div>
</div>

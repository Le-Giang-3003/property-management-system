@model PropertyManagementSystem.Web.ViewModels.Lease.CreateLeaseViewModel
@{
    ViewData["Title"] = "Create Lease";
    Layout = "_AuthLayout";
    ViewData["PortalMode"] = "Landlord";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Leases</a></li>
                    <li class="breadcrumb-item active">Create New</li>
                </ol>
            </nav>

            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-file-contract"></i> Create New Lease</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="createLeaseForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="ApplicationId" />
                        <input type="hidden" asp-for="StartDate" />
                        <input type="hidden" asp-for="OriginalStartDay" />
                        <input type="hidden" asp-for="PaymentDueDay" />

                        <!-- Rental Application Info -->
                        <div class="alert alert-info mb-4">
                            <h5 class="alert-heading">
                                <i class="fas fa-info-circle"></i> Rental Application Information
                            </h5>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Application ID:</strong> @Model.ApplicationNumber</p>
                                    <p class="mb-2"><strong>Property:</strong> @Model.PropertyName</p>
                                    <p class="mb-0"><strong>Address:</strong> @Model.PropertyAddress</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Tenant:</strong> @Model.TenantName</p>
                                    <p class="mb-2"><strong>Email:</strong> @Model.TenantEmail</p>
                                    <p class="mb-0"><strong>Phone:</strong> @Model.TenantPhone</p>
                                </div>
                            </div>
                        </div>

                        <!-- Section 1: Lease Duration -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Lease Duration</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-calendar-check text-success"></i> Start Date
                                        </label>
                                        <input type="text" class="form-control form-control-lg"
                                               value="@Model.StartDate.ToString("dd/MM/yyyy")" readonly />
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label asp-for="LeaseDurationMonths" class="form-label fw-bold">
                                            <i class="fas fa-hourglass-half text-primary"></i> Lease Term
                                        </label>
                                        <select asp-for="LeaseDurationMonths" asp-items="Model.DurationOptions"
                                                class="form-select form-select-lg" id="LeaseDurationMonths">
                                        </select>
                                        <span asp-validation-for="LeaseDurationMonths" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar-times text-danger"></i> End Date (Expected)
                                    </label>
                                    <input type="text" class="form-control form-control-lg bg-light"
                                           id="endDateDisplay" value="@Model.EndDate.ToString("dd/MM/yyyy")" readonly />
                                </div>

                                <!-- Payment date warning -->
                                @if (Model.OriginalStartDay >= 29)
                                {
                                    <div class="alert alert-warning border-warning">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Payment Date Adjustment Notice
                                        </h6>
                                        <hr>
                                        <p class="mb-2">
                                            The lease start date is <strong>@Model.StartDate.ToString("dd/MM/yyyy")</strong>
                                            (day <strong class="text-danger">@Model.OriginalStartDay</strong> of the month).
                                        </p>
                                        <p class="mb-2">
                                            Since not all months have day @Model.OriginalStartDay
                                            (e.g., February only has 28-29 days, some months only have 30 days),
                                            to ensure consistency and avoid confusion:
                                        </p>
                                        <div class="bg-white p-3 rounded">
                                            <p class="mb-0">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <strong>Monthly payment date</strong> will be adjusted to
                                                <strong class="text-danger fs-5">day 28</strong>
                                                (fixed for all months).
                                            </p>
                                        </div>
                                    </div>
                                }

                                <div class="alert alert-light border">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <i class="fas fa-calendar-day fa-3x text-primary"></i>
                                        </div>
                                        <div class="col">
                                            <small class="text-muted">Monthly Payment Due Date</small>
                                            <h4 class="mb-0 text-primary">
                                                Day @(Model.PaymentDueDay > 0 ? Model.PaymentDueDay : Model.StartDate.Day)
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Financial Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Financial Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="MonthlyRent" class="form-label fw-bold">
                                            <i class="fas fa-hand-holding-usd text-success"></i> Monthly Rent
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <input asp-for="MonthlyRent" type="number" step="1000"
                                                   class="form-control" placeholder="5000000" id="MonthlyRent" />
                                            <span class="input-group-text bg-success text-white fw-bold">$</span>
                                        </div>
                                        <span asp-validation-for="MonthlyRent" class="text-danger"></span>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label asp-for="SecurityDeposit" class="form-label fw-bold">
                                            <i class="fas fa-shield-alt text-warning"></i> Security Deposit
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <input asp-for="SecurityDeposit" type="number" step="1000"
                                                   class="form-control" placeholder="10000000" id="SecurityDeposit" />
                                            <span class="input-group-text bg-warning text-dark fw-bold">$</span>
                                        </div>
                                        <span asp-validation-for="SecurityDeposit" class="text-danger"></span>
                                    </div>
                                </div>

                                <!-- Total preview -->
                                <div class="alert alert-success" id="financialSummary">
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <small class="text-muted">Total Due at Signing</small>
                                            <h4 class="mb-0" id="totalInitial">$0</h4>
                                            <small>(First month rent + Deposit)</small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">Total Contract Value</small>
                                            <h4 class="mb-0" id="totalContract">$0</h4>
                                            <small>(Rent Ã— <span id="monthsDisplay">12</span> months)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Contract Terms -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-file-signature"></i> Contract Terms</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="Terms" class="form-label fw-bold">
                                        <i class="fas fa-file-alt"></i> Detailed Terms
                                        <span class="badge bg-secondary ms-2">Optional</span>
                                    </label>
                                    <textarea asp-for="Terms" class="form-control font-monospace" rows="10"
                                              placeholder="Leave blank to use system default terms..."></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-magic text-primary"></i>
                                        If left blank, the system will automatically generate standard terms based on contract info
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="SpecialConditions" class="form-label fw-bold">
                                        <i class="fas fa-star text-warning"></i> Special Conditions
                                        <span class="badge bg-secondary ms-2">Optional</span>
                                    </label>
                                    <textarea asp-for="SpecialConditions" class="form-control" rows="3"
                                              placeholder="E.g.: Pets allowed, Private parking, Room can be repainted..."></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i>
                                        Only fill in if there are special conditions beyond standard terms
                                    </div>
                                </div>

                                <div class="form-check form-switch">
                                    <input asp-for="AutoRenew" class="form-check-input" type="checkbox"
                                           role="switch" id="autoRenewSwitch" />
                                    <label asp-for="AutoRenew" class="form-check-label fw-bold" for="autoRenewSwitch">
                                        <i class="fas fa-sync-alt"></i> Auto-renew on expiration
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-controller="RentalApplication" asp-action="Details"
                               asp-route-id="@Model.ApplicationId"
                               class="btn btn-lg btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-lg btn-primary">
                                <i class="fas fa-check-circle"></i> Create Lease
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const leaseDurationSelect = document.getElementById('LeaseDurationMonths');
            const monthlyRentInput = document.getElementById('MonthlyRent');
            const securityDepositInput = document.getElementById('SecurityDeposit');
            const endDateDisplay = document.getElementById('endDateDisplay');
            const totalInitialDisplay = document.getElementById('totalInitial');
            const totalContractDisplay = document.getElementById('totalContract');
            const monthsDisplay = document.getElementById('monthsDisplay');

            const startDate = new Date('@Model.StartDate.ToString("yyyy-MM-dd")');

            function updateCalculations() {
                const months = parseInt(leaseDurationSelect.value) || 12;
                const monthlyRent = parseFloat(monthlyRentInput.value) || 0;
                const securityDeposit = parseFloat(securityDepositInput.value) || 0;

                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + months);

                const day = String(endDate.getDate()).padStart(2, '0');
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const year = endDate.getFullYear();

                endDateDisplay.value = day + '/' + month + '/' + year;

                const totalInitial = monthlyRent + securityDeposit;
                const totalContract = monthlyRent * months;

                totalInitialDisplay.textContent = '$' + totalInitial.toLocaleString('en-US');
                totalContractDisplay.textContent = '$' + totalContract.toLocaleString('en-US');
                monthsDisplay.textContent = months;
            }

            leaseDurationSelect.addEventListener('change', updateCalculations);
            monthlyRentInput.addEventListener('input', updateCalculations);
            securityDepositInput.addEventListener('input', updateCalculations);

            updateCalculations();

            const form = document.getElementById('createLeaseForm');
            form.addEventListener('submit', function(e) {
                const monthlyRent = parseFloat(monthlyRentInput.value);
                const securityDeposit = parseFloat(securityDepositInput.value);

                if (monthlyRent <= 0) {
                    e.preventDefault();
                    alert('Please enter a valid rent amount!');
                    monthlyRentInput.focus();
                    return false;
                }

                if (securityDeposit < 0) {
                    e.preventDefault();
                    alert('Deposit cannot be negative!');
                    securityDepositInput.focus();
                    return false;
                }

                if (!confirm('Are you sure you want to create this lease?')) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}

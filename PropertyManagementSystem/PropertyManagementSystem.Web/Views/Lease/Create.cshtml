@model PropertyManagementSystem.Web.ViewModels.Lease.CreateLeaseViewModel
@{
    ViewData["Title"] = "Create Lease";
    Layout = "_AuthLayout";
    ViewData["PortalMode"] = "Landlord";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">Hợp đồng</a></li>
                    <li class="breadcrumb-item active">Tạo mới</li>
                </ol>
            </nav>

            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-file-contract"></i> Tạo hợp đồng thuê mới</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="createLeaseForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="ApplicationId" />
                        <input type="hidden" asp-for="StartDate" />
                        <input type="hidden" asp-for="OriginalStartDay" />
                        <input type="hidden" asp-for="PaymentDueDay" />

                        <!-- Thông tin đơn xin thuê -->
                        <div class="alert alert-info mb-4">
                            <h5 class="alert-heading">
                                <i class="fas fa-info-circle"></i> Thông tin từ đơn xin thuê
                            </h5>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Mã đơn:</strong> @Model.ApplicationNumber</p>
                                    <p class="mb-2"><strong>Bất động sản:</strong> @Model.PropertyName</p>
                                    <p class="mb-0"><strong>Địa chỉ:</strong> @Model.PropertyAddress</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Người thuê:</strong> @Model.TenantName</p>
                                    <p class="mb-2"><strong>Email:</strong> @Model.TenantEmail</p>
                                    <p class="mb-0"><strong>SĐT:</strong> @Model.TenantPhone</p>
                                </div>
                            </div>
                        </div>

                        <!-- Phần 1: Thời gian hợp đồng -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Thời gian hợp đồng</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-calendar-check text-success"></i> Ngày bắt đầu
                                        </label>
                                        <input type="text" class="form-control form-control-lg"
                                               value="@Model.StartDate.ToString("dd/MM/yyyy")" readonly />
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label asp-for="LeaseDurationMonths" class="form-label fw-bold">
                                            <i class="fas fa-hourglass-half text-primary"></i> Thời hạn thuê
                                        </label>
                                        <select asp-for="LeaseDurationMonths" asp-items="Model.DurationOptions"
                                                class="form-select form-select-lg" id="LeaseDurationMonths">
                                        </select>
                                        <span asp-validation-for="LeaseDurationMonths" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar-times text-danger"></i> Ngày kết thúc (dự kiến)
                                    </label>
                                    <input type="text" class="form-control form-control-lg bg-light"
                                           id="endDateDisplay" value="@Model.EndDate.ToString("dd/MM/yyyy")" readonly />
                                </div>

                                <!-- Cảnh báo ngày thanh toán -->
                                @if (Model.OriginalStartDay >= 29)
                                {
                                    <div class="alert alert-warning border-warning">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Thông báo điều chỉnh ngày thanh toán
                                        </h6>
                                        <hr>
                                        <p class="mb-2">
                                            Ngày bắt đầu hợp đồng là <strong>@Model.StartDate.ToString("dd/MM/yyyy")</strong>
                                            (ngày <strong class="text-danger">@Model.OriginalStartDay</strong> trong tháng).
                                        </p>
                                        <p class="mb-2">
                                            Do không phải tháng nào cũng có ngày @Model.OriginalStartDay
                                            (ví dụ: tháng 2 chỉ có 28-29 ngày, một số tháng chỉ có 30 ngày),
                                            để đảm bảo tính nhất quán và tránh nhầm lẫn:
                                        </p>
                                        <div class="bg-white p-3 rounded">
                                            <p class="mb-0">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <strong>Ngày thanh toán hàng tháng</strong> sẽ được điều chỉnh về
                                                <strong class="text-danger fs-5">ngày 28</strong>
                                                (cố định cho tất cả các tháng).
                                            </p>
                                        </div>
                                    </div>
                                }

                                <div class="alert alert-light border">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <i class="fas fa-calendar-day fa-3x text-primary"></i>
                                        </div>
                                        <div class="col">
                                            <small class="text-muted">Ngày thanh toán hàng tháng</small>
                                            <h4 class="mb-0 text-primary">
                                                Ngày @(Model.PaymentDueDay > 0 ? Model.PaymentDueDay : Model.StartDate.Day)
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phần 2: Thông tin tài chính -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Thông tin tài chính</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="MonthlyRent" class="form-label fw-bold">
                                            <i class="fas fa-hand-holding-usd text-success"></i> Tiền thuê hàng tháng
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <input asp-for="MonthlyRent" type="number" step="1000"
                                                   class="form-control" placeholder="5000000" id="MonthlyRent" />
                                            <span class="input-group-text bg-success text-white fw-bold">VNĐ</span>
                                        </div>
                                        <span asp-validation-for="MonthlyRent" class="text-danger"></span>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label asp-for="SecurityDeposit" class="form-label fw-bold">
                                            <i class="fas fa-shield-alt text-warning"></i> Tiền đặt cọc
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <input asp-for="SecurityDeposit" type="number" step="1000"
                                                   class="form-control" placeholder="10000000" id="SecurityDeposit" />
                                            <span class="input-group-text bg-warning text-dark fw-bold">VNĐ</span>
                                        </div>
                                        <span asp-validation-for="SecurityDeposit" class="text-danger"></span>
                                    </div>
                                </div>

                                <!-- Preview tổng tiền -->
                                <div class="alert alert-success" id="financialSummary">
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <small class="text-muted">Tổng tiền phải trả khi ký HĐ</small>
                                            <h4 class="mb-0" id="totalInitial">0 VNĐ</h4>
                                            <small>(Tiền thuê tháng đầu + Tiền cọc)</small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">Tổng giá trị hợp đồng</small>
                                            <h4 class="mb-0" id="totalContract">0 VNĐ</h4>
                                            <small>(Tiền thuê × <span id="monthsDisplay">12</span> tháng)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phần 3: Điều khoản hợp đồng -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-file-signature"></i> Điều khoản hợp đồng</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="Terms" class="form-label fw-bold">
                                        <i class="fas fa-file-alt"></i> Điều khoản chi tiết
                                        <span class="badge bg-secondary ms-2">Tùy chọn</span>
                                    </label>
                                    <textarea asp-for="Terms" class="form-control font-monospace" rows="10"
                                              placeholder="Để trống nếu muốn sử dụng điều khoản mặc định của hệ thống..."></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-magic text-primary"></i>
                                        Nếu để trống, hệ thống sẽ tự động tạo điều khoản chuẩn dựa trên thông tin hợp đồng
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="SpecialConditions" class="form-label fw-bold">
                                        <i class="fas fa-star text-warning"></i> Điều kiện đặc biệt
                                        <span class="badge bg-secondary ms-2">Tùy chọn</span>
                                    </label>
                                    <textarea asp-for="SpecialConditions" class="form-control" rows="3"
                                              placeholder="VD: Được phép nuôi thú cưng, Có chỗ đậu xe riêng, Được sơn lại phòng..."></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i>
                                        Chỉ điền nếu có điều kiện đặc biệt ngoài điều khoản chuẩn
                                    </div>
                                </div>

                                <div class="form-check form-switch">
                                    <input asp-for="AutoRenew" class="form-check-input" type="checkbox"
                                           role="switch" id="autoRenewSwitch" />
                                    <label asp-for="AutoRenew" class="form-check-label fw-bold" for="autoRenewSwitch">
                                        <i class="fas fa-sync-alt"></i> Tự động gia hạn khi hết hạn
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a asp-controller="RentalApplication" asp-action="Details"
                               asp-route-id="@Model.ApplicationId"
                               class="btn btn-lg btn-outline-secondary">
                                <i class="fas fa-times"></i> Hủy bỏ
                            </a>
                            <button type="submit" class="btn btn-lg btn-primary">
                                <i class="fas fa-check-circle"></i> Tạo hợp đồng
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const leaseDurationSelect = document.getElementById('LeaseDurationMonths');
            const monthlyRentInput = document.getElementById('MonthlyRent');
            const securityDepositInput = document.getElementById('SecurityDeposit');
            const endDateDisplay = document.getElementById('endDateDisplay');
            const totalInitialDisplay = document.getElementById('totalInitial');
            const totalContractDisplay = document.getElementById('totalContract');
            const monthsDisplay = document.getElementById('monthsDisplay');

            const startDate = new Date('@Model.StartDate.ToString("yyyy-MM-dd")');

            function updateCalculations() {
                const months = parseInt(leaseDurationSelect.value) || 12;
                const monthlyRent = parseFloat(monthlyRentInput.value) || 0;
                const securityDeposit = parseFloat(securityDepositInput.value) || 0;

                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + months);

                const day = String(endDate.getDate()).padStart(2, '0');
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const year = endDate.getFullYear();

                endDateDisplay.value = day + '/' + month + '/' + year;

                const totalInitial = monthlyRent + securityDeposit;
                const totalContract = monthlyRent * months;

                totalInitialDisplay.textContent = totalInitial.toLocaleString('vi-VN') + ' VNĐ';
                totalContractDisplay.textContent = totalContract.toLocaleString('vi-VN') + ' VNĐ';
                monthsDisplay.textContent = months;
            }

            leaseDurationSelect.addEventListener('change', updateCalculations);
            monthlyRentInput.addEventListener('input', updateCalculations);
            securityDepositInput.addEventListener('input', updateCalculations);

            updateCalculations();

            const form = document.getElementById('createLeaseForm');
            form.addEventListener('submit', function(e) {
                const monthlyRent = parseFloat(monthlyRentInput.value);
                const securityDeposit = parseFloat(securityDepositInput.value);

                if (monthlyRent <= 0) {
                    e.preventDefault();
                    alert('Vui lòng nhập tiền thuê hợp lệ!');
                    monthlyRentInput.focus();
                    return false;
                }

                if (securityDeposit < 0) {
                    e.preventDefault();
                    alert('Tiền cọc không được âm!');
                    securityDepositInput.focus();
                    return false;
                }

                if (!confirm('Bạn có chắc muốn tạo hợp đồng này?')) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}

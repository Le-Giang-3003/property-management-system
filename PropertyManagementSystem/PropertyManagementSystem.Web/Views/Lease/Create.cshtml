@model PropertyManagementSystem.Web.ViewModels.Lease.CreateLeaseViewModel
@{
    ViewData["Title"] = "Create Lease";
    Layout = "_AuthLayout";
    ViewData["PortalMode"] = "Landlord";
}

<div class="pm-page">
    <div class="pm-page-header">
        <div>
            <h1 class="pm-page-title">
                <i class="bi bi-file-earmark-plus"></i>
                Create New Lease
            </h1>
            <p class="pm-page-subtitle">Create a lease contract from approved application</p>
        </div>
    </div>

    <div class="pm-card">
        <div class="pm-card-body">
                    <form asp-action="Create" method="post" id="createLeaseForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="ApplicationId" />
                        <input type="hidden" asp-for="StartDate" />
                        <input type="hidden" asp-for="OriginalStartDay" />
                        <input type="hidden" asp-for="PaymentDueDay" />

            <!-- Application Info -->
            <div class="pm-card-modern mb-4" style="border-color: var(--pm-info); background: var(--pm-info-50);">
                <div class="pm-stat-header">
                    <span class="pm-stat-label">
                        <i class="bi bi-info-circle"></i> Rental Application Information
                    </span>
                </div>
                <div class="pm-info-grid">
                    <div>
                        <p class="pm-info-item">
                            <span class="pm-info-label">Application ID:</span>
                            <span class="pm-info-value">@Model.ApplicationNumber</span>
                        </p>
                        <p class="pm-info-item">
                            <span class="pm-info-label">Property:</span>
                            <span class="pm-info-value">@Model.PropertyName</span>
                        </p>
                        <p class="pm-info-item">
                            <span class="pm-info-label">Address:</span>
                            <span class="pm-info-value">@Model.PropertyAddress</span>
                        </p>
                    </div>
                    <div>
                        <p class="pm-info-item">
                            <span class="pm-info-label">Tenant:</span>
                            <span class="pm-info-value">@Model.TenantName</span>
                        </p>
                        <p class="pm-info-item">
                            <span class="pm-info-label">Email:</span>
                            <span class="pm-info-value">@Model.TenantEmail</span>
                        </p>
                        <p class="pm-info-item">
                            <span class="pm-info-label">Phone:</span>
                            <span class="pm-info-value">@Model.TenantPhone</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Lease Duration -->
            <div class="pm-info-section mb-4">
                <div class="pm-section-header">
                    <i class="bi bi-calendar-range"></i>
                    <h3>Lease Duration</h3>
                </div>
                <div class="pm-form-grid">
                    <div class="pm-form-group">
                        <label class="pm-label">
                            <i class="bi bi-calendar-check"></i> Start Date
                        </label>
                        <input type="text" class="pm-input"
                               value="@Model.StartDate.ToString("MMM dd, yyyy")" readonly />
                    </div>

                    <div class="pm-form-group">
                        <label asp-for="LeaseDurationMonths" class="pm-label">
                            <i class="bi bi-hourglass-split"></i> Lease Term
                        </label>
                        <select asp-for="LeaseDurationMonths" asp-items="Model.DurationOptions"
                                class="pm-select" id="LeaseDurationMonths">
                        </select>
                        <span asp-validation-for="LeaseDurationMonths" class="pm-error"></span>
                    </div>

                    <div class="pm-form-group">
                        <label class="pm-label">
                            <i class="bi bi-calendar-x"></i> End Date (Expected)
                        </label>
                        <input type="text" class="pm-input"
                               id="endDateDisplay" value="@Model.EndDate.ToString("MMM dd, yyyy")" readonly />
                    </div>

                    <!-- Payment date warning -->
                    @if (Model.OriginalStartDay >= 29)
                    {
                        <div class="pm-alert pm-alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div>
                                <strong>Payment Date Adjustment Notice</strong>
                                <p>The lease start date is <strong>@Model.StartDate.ToString("MMM dd, yyyy")</strong>
                                    (day <strong>@Model.OriginalStartDay</strong> of the month).</p>
                                <p>Since not all months have day @Model.OriginalStartDay, monthly payment date will be adjusted to <strong>day 28</strong> (fixed for all months).</p>
                            </div>
                        </div>
                    }

                    <div class="pm-card-modern">
                        <div class="pm-payment-due-info">
                            <i class="bi bi-calendar-day"></i>
                            <div>
                                <span class="pm-payment-due-label">Monthly Payment Due Date</span>
                                <span class="pm-payment-due-value">Day @(Model.PaymentDueDay > 0 ? Model.PaymentDueDay : Model.StartDate.Day)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Information -->
            <div class="pm-info-section mb-4">
                <div class="pm-section-header">
                    <i class="bi bi-currency-dollar"></i>
                    <h3>Financial Information</h3>
                </div>
                <div class="pm-form-grid">
                    <div class="pm-form-group">
                        <label asp-for="MonthlyRent" class="pm-label">
                            <i class="bi bi-cash-coin"></i> Monthly Rent
                        </label>
                        <div class="pm-input-group">
                            <input asp-for="MonthlyRent" type="number" step="0.01" min="0"
                                   class="pm-input" placeholder="5000000" id="MonthlyRent" />
                            <span class="pm-input-addon">₫</span>
                        </div>
                        <span asp-validation-for="MonthlyRent" class="pm-error"></span>
                    </div>

                    <div class="pm-form-group">
                        <label asp-for="SecurityDeposit" class="pm-label">
                            <i class="bi bi-shield-check"></i> Security Deposit
                        </label>
                        <div class="pm-input-group">
                            <input asp-for="SecurityDeposit" type="number" step="0.01" min="0"
                                   class="pm-input" placeholder="10000000" id="SecurityDeposit" />
                            <span class="pm-input-addon">₫</span>
                        </div>
                        <span asp-validation-for="SecurityDeposit" class="pm-error"></span>
                    </div>
                </div>

                <!-- Total preview -->
                <div class="pm-card-modern mt-4" style="background: var(--pm-success-50); border-color: var(--pm-success);" id="financialSummary">
                    <div class="pm-financial-summary">
                        <div class="pm-summary-item">
                            <span class="pm-summary-label">Total Due at Signing</span>
                            <span class="pm-summary-value" id="totalInitial">0 ₫</span>
                            <span class="pm-summary-note">(First month rent + Deposit)</span>
                        </div>
                        <div class="pm-summary-item">
                            <span class="pm-summary-label">Total Contract Value</span>
                            <span class="pm-summary-value" id="totalContract">0 ₫</span>
                            <span class="pm-summary-note">(Rent × <span id="monthsDisplay">12</span> months)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contract Terms -->
            <div class="pm-info-section mb-4">
                <div class="pm-section-header">
                    <i class="bi bi-file-text"></i>
                    <h3>Contract Terms</h3>
                </div>
                <div class="pm-form-group">
                    <label asp-for="Terms" class="pm-label">
                        Detailed Terms
                        <span class="pm-badge pm-badge-secondary">Optional</span>
                    </label>
                    <textarea asp-for="Terms" class="pm-textarea" rows="10"
                              placeholder="Leave blank to use system default terms..."></textarea>
                    <span class="pm-hint">
                        <i class="bi bi-info-circle"></i>
                        If left blank, the system will automatically generate standard terms based on contract info
                    </span>
                </div>

                <div class="pm-form-group">
                    <label asp-for="SpecialConditions" class="pm-label">
                        Special Conditions
                        <span class="pm-badge pm-badge-secondary">Optional</span>
                    </label>
                    <textarea asp-for="SpecialConditions" class="pm-textarea" rows="3"
                              placeholder="E.g.: Pets allowed, Private parking, Room can be repainted..."></textarea>
                    <span class="pm-hint">
                        <i class="bi bi-info-circle"></i>
                        Only fill in if there are special conditions beyond standard terms
                    </span>
                </div>

                <div class="pm-checkbox">
                    <input asp-for="AutoRenew" type="checkbox" id="autoRenewSwitch" />
                    <label asp-for="AutoRenew" for="autoRenewSwitch">
                        <i class="bi bi-arrow-repeat"></i> Auto-renew on expiration
                    </label>
                </div>
            </div>

            <!-- Actions -->
            <div class="pm-navigation-actions">
                <a asp-controller="RentalApplication" asp-action="Details"
                   asp-route-id="@Model.ApplicationId"
                   class="pm-btn pm-btn-secondary">
                    <i class="bi bi-x"></i> Cancel
                </a>
                <button type="submit" class="pm-btn pm-btn-primary">
                    <i class="bi bi-check-circle"></i> Create Lease
                </button>
            </div>
        </form>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .pm-page {
            max-width: 1200px;
            margin: 0 auto;
        }

        .pm-page-header {
            margin-bottom: var(--pm-space-6);
        }

        .pm-page-title {
            font-size: var(--pm-text-2xl);
            font-weight: var(--pm-font-bold);
            color: var(--pm-text);
            margin: 0 0 var(--pm-space-2);
            display: flex;
            align-items: center;
            gap: var(--pm-space-3);
        }

        .pm-page-title i {
            color: var(--pm-primary);
        }

        .pm-page-subtitle {
            font-size: var(--pm-text-sm);
            color: var(--pm-text-muted);
            margin: 0;
        }

        .pm-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--pm-space-4);
        }

        .pm-input-group {
            display: flex;
            align-items: center;
        }

        .pm-input-group .pm-input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .pm-input-addon {
            padding: var(--pm-space-3) var(--pm-space-4);
            background: var(--pm-slate-100);
            border: 1px solid var(--pm-border);
            border-left: none;
            border-top-right-radius: var(--pm-radius-lg);
            border-bottom-right-radius: var(--pm-radius-lg);
            color: var(--pm-text-secondary);
            font-weight: var(--pm-font-semibold);
        }

        .pm-payment-due-info {
            display: flex;
            align-items: center;
            gap: var(--pm-space-4);
            padding: var(--pm-space-4);
        }

        .pm-payment-due-info i {
            font-size: 32px;
            color: var(--pm-primary);
        }

        .pm-payment-due-label {
            display: block;
            font-size: var(--pm-text-xs);
            color: var(--pm-text-muted);
            margin-bottom: var(--pm-space-1);
        }

        .pm-payment-due-value {
            display: block;
            font-size: var(--pm-text-2xl);
            font-weight: var(--pm-font-bold);
            color: var(--pm-primary);
        }

        .pm-financial-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--pm-space-4);
        }

        .pm-summary-item {
            text-align: center;
        }

        .pm-summary-label {
            display: block;
            font-size: var(--pm-text-xs);
            color: var(--pm-text-muted);
            margin-bottom: var(--pm-space-2);
        }

        .pm-summary-value {
            display: block;
            font-size: var(--pm-text-2xl);
            font-weight: var(--pm-font-bold);
            color: var(--pm-success);
            margin-bottom: var(--pm-space-1);
        }

        .pm-summary-note {
            display: block;
            font-size: var(--pm-text-xs);
            color: var(--pm-text-muted);
        }

        .pm-navigation-actions {
            display: flex;
            gap: var(--pm-space-3);
            justify-content: flex-end;
            margin-top: var(--pm-space-6);
            padding-top: var(--pm-space-6);
            border-top: 1px solid var(--pm-border);
        }

        @@media (max-width: 768px) {
            .pm-form-grid {
                grid-template-columns: 1fr;
            }

            .pm-financial-summary {
                grid-template-columns: 1fr;
            }

            .pm-navigation-actions {
                flex-direction: column;
            }

            .pm-navigation-actions .pm-btn {
                width: 100%;
            }
        }
    </style>
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const leaseDurationSelect = document.getElementById('LeaseDurationMonths');
            const monthlyRentInput = document.getElementById('MonthlyRent');
            const securityDepositInput = document.getElementById('SecurityDeposit');
            const endDateDisplay = document.getElementById('endDateDisplay');
            const totalInitialDisplay = document.getElementById('totalInitial');
            const totalContractDisplay = document.getElementById('totalContract');
            const monthsDisplay = document.getElementById('monthsDisplay');

            const startDate = new Date('@Model.StartDate.ToString("yyyy-MM-dd")');

            // Format number to remove .00 if it's a whole number
            function formatNumber(value) {
                if (!value && value !== 0) return '';
                const num = parseFloat(value);
                if (isNaN(num)) return value;
                // If it's a whole number, return without decimals
                if (num % 1 === 0) {
                    return num.toString();
                }
                return num.toString();
            }

            // Format inputs on page load
            if (monthlyRentInput.value) {
                monthlyRentInput.value = formatNumber(monthlyRentInput.value);
            }
            if (securityDepositInput.value) {
                securityDepositInput.value = formatNumber(securityDepositInput.value);
            }

            // Format on blur (when user leaves the field)
            monthlyRentInput.addEventListener('blur', function() {
                if (this.value) {
                    this.value = formatNumber(this.value);
                }
            });

            securityDepositInput.addEventListener('blur', function() {
                if (this.value) {
                    this.value = formatNumber(this.value);
                }
            });

            function updateCalculations() {
                const months = parseInt(leaseDurationSelect.value) || 12;
                const monthlyRent = parseFloat(monthlyRentInput.value) || 0;
                const securityDeposit = parseFloat(securityDepositInput.value) || 0;

                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + months);

                const day = String(endDate.getDate()).padStart(2, '0');
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const year = endDate.getFullYear();

                endDateDisplay.value = day + '/' + month + '/' + year;

                const totalInitial = monthlyRent + securityDeposit;
                const totalContract = monthlyRent * months;

                totalInitialDisplay.textContent = totalInitial.toLocaleString('en-US') + ' ₫';
                totalContractDisplay.textContent = totalContract.toLocaleString('en-US') + ' ₫';
                monthsDisplay.textContent = months;
            }

            leaseDurationSelect.addEventListener('change', updateCalculations);
            monthlyRentInput.addEventListener('input', updateCalculations);
            securityDepositInput.addEventListener('input', updateCalculations);

            updateCalculations();

            // Validate multiple of 1000 on input
            function validateMultipleOf1000(input, fieldName) {
                const value = parseFloat(input.value);
                if (isNaN(value) || value <= 0) {
                    return true; // Let other validations handle this
                }
                
                // Check if value is a multiple of 1000
                if (value % 1000 !== 0) {
                    input.setCustomValidity('Please enter a multiple of 1000');
                    return false;
                } else {
                    input.setCustomValidity('');
                    return true;
                }
            }

            monthlyRentInput.addEventListener('blur', function() {
                // Format number first
                if (this.value) {
                    this.value = formatNumber(this.value);
                }
                validateMultipleOf1000(this, 'Monthly Rent');
            });

            monthlyRentInput.addEventListener('input', function() {
                if (this.validity.customError) {
                    validateMultipleOf1000(this, 'Monthly Rent');
                }
            });

            securityDepositInput.addEventListener('blur', function() {
                // Format number first
                if (this.value) {
                    this.value = formatNumber(this.value);
                }
                validateMultipleOf1000(this, 'Security Deposit');
            });

            securityDepositInput.addEventListener('input', function() {
                if (this.validity.customError) {
                    validateMultipleOf1000(this, 'Security Deposit');
                }
            });

            const form = document.getElementById('createLeaseForm');
            form.addEventListener('submit', function(e) {
                const monthlyRent = parseFloat(monthlyRentInput.value);
                const securityDeposit = parseFloat(securityDepositInput.value);

                if (monthlyRent <= 0) {
                    e.preventDefault();
                    alert('Please enter a valid rent amount!');
                    monthlyRentInput.focus();
                    return false;
                }

                if (securityDeposit < 0) {
                    e.preventDefault();
                    alert('Deposit cannot be negative!');
                    securityDepositInput.focus();
                    return false;
                }

                // Validate multiple of 1000
                if (!validateMultipleOf1000(monthlyRentInput, 'Monthly Rent')) {
                    e.preventDefault();
                    monthlyRentInput.focus();
                    return false;
                }

                if (!validateMultipleOf1000(securityDepositInput, 'Security Deposit')) {
                    e.preventDefault();
                    securityDepositInput.focus();
                    return false;
                }

                if (!confirm('Are you sure you want to create this lease?')) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}

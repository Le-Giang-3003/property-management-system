@model PropertyManagementSystem.BLL.DTOs.Schedule.PagedViewingResultDto
@{
    ViewData["Title"] = "Viewing History";
    var filter = ViewBag.Filter as PropertyManagementSystem.BLL.DTOs.Schedule.ViewingHistoryFilterDto;
    var currentRole = ViewBag.CurrentRole as string;
}

<h2>Viewing History</h2>

@if (TempData["SuccessMessage"] != null)
{
    <p style="color:green;">@TempData["SuccessMessage"]</p>
}

@* === FILTER FORM === *@
<form method="get" asp-action="History">
    <table cellpadding="5">
        <tr>
            <td>
                <label>Status:</label><br />
                <select name="Status">
                    <option value="">-- All --</option>
                    <option value="Completed" selected="@(filter?.Status == "Completed")">Completed</option>
                    <option value="Cancelled" selected="@(filter?.Status == "Cancelled")">Cancelled</option>
                    <option value="Rejected" selected="@(filter?.Status == "Rejected")">Rejected</option>
                </select>
            </td>
            <td>
                <label>From Date:</label><br />
                <input type="date" name="FromDate" value="@filter?.FromDate?.ToString("yyyy-MM-dd")" />
            </td>
            <td>
                <label>To Date:</label><br />
                <input type="date" name="ToDate" value="@filter?.ToDate?.ToString("yyyy-MM-dd")" />
            </td>
            <td>
                <label>Search:</label><br />
                <input type="text" name="SearchTerm" value="@filter?.SearchTerm" placeholder="Property or name..." />
            </td>
            <td style="vertical-align: bottom;">
                <button type="submit">Filter</button>
                <a asp-action="History">Clear</a>
            </td>
        </tr>
    </table>
</form>

<hr />

@* === STATISTICS === *@
<p>
    Total: <strong>@Model.TotalCount</strong> records |
    Page <strong>@Model.PageNumber</strong> of <strong>@Model.TotalPages</strong>
</p>

@* === DATA TABLE === *@
@if (!Model.Items.Any())
{
    <p>No viewing history found.</p>
}
else
{
    <table border="1" cellpadding="8" cellspacing="0">
        <thead>
            <tr>
                <th>Property</th>
                <th>Requester</th>
                <th>Requested Date</th>
                <th>Scheduled Date</th>
                <th>Status</th>
                @if (currentRole == "Admin")
                {
                    <th>Landlord</th>
                }
                <th>Rating</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Items)
            {
                <tr>
                    <td>
                        @item.PropertyName<br />
                        <small>@item.PropertyAddress</small>
                    </td>
                    <td>
                        @item.RequesterName<br />
                        <small>@item.RequesterEmail</small>
                    </td>
                    <td>@item.PreferredDate1?.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        @if (item.ScheduledDate.HasValue)
                        {
                            @item.ScheduledDate.Value.ToString("dd/MM/yyyy HH:mm")
                        }
                        else
                        {
                            <text>-</text>
                        }
                    </td>
                    <td>
                        @{
                            var statusColor = item.Status switch
                            {
                                "Completed" => "green",
                                "Cancelled" => "gray",
                                "Rejected" => "red",
                                _ => "black"
                            };
                        }
                        <span style="color:@statusColor;">@item.Status</span>
                    </td>
                    @if (currentRole == "Admin")
                    {
                        <td>@item.LandlordName</td>
                    }
                    <td>
                        @if (item.Rating.HasValue)
                        {
                            <text>@item.Rating.Value / 5</text>
                        }
                        else
                        {
                            <text>-</text>
                        }
                    </td>
                    <td>
                        <a asp-action="Details" asp-route-id="@item.ViewingId">Details</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @* === PAGINATION === *@
    <br />
    <div>
        @if (Model.HasPreviousPage)
        {
            <a asp-action="History"
               asp-route-Status="@filter?.Status"
               asp-route-FromDate="@filter?.FromDate?.ToString("yyyy-MM-dd")"
               asp-route-ToDate="@filter?.ToDate?.ToString("yyyy-MM-dd")"
               asp-route-SearchTerm="@filter?.SearchTerm"
               asp-route-PageNumber="@(Model.PageNumber - 1)">« Previous</a>
        }

        <span> | Page @Model.PageNumber of @Model.TotalPages | </span>

        @if (Model.HasNextPage)
        {
            <a asp-action="History"
               asp-route-Status="@filter?.Status"
               asp-route-FromDate="@filter?.FromDate?.ToString("yyyy-MM-dd")"
               asp-route-ToDate="@filter?.ToDate?.ToString("yyyy-MM-dd")"
               asp-route-SearchTerm="@filter?.SearchTerm"
               asp-route-PageNumber="@(Model.PageNumber + 1)">Next »</a>
        }
    </div>
}

<hr />
<p>
    @if (currentRole == "Tenant")
    {
        <a asp-action="MyViewings">← Back to My Viewings</a>
    }
    else if (currentRole == "Landlord")
    {
        <a asp-action="ManageViewings">← Back to Manage Viewings</a>
    }
</p>